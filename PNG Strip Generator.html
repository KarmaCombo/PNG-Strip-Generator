<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PNG Strip Generator ‚Äî GIF ‚Üí PNG Strip</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0f1720;--card:#0b1320;--muted:#9fb3d0;--accent:#38bdf8;--ok:#10b981}
  body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#e6eef8;display:flex;align-items:flex-start;justify-content:center;min-height:100vh;padding:16px;margin:0}
  .card{width:95vw;max-width:1200px;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 8px 36px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
  h1{margin:0;font-size:24px}
  p.lead{color:var(--muted);margin:6px 0 14px;font-size:14px}
  .links{margin-top:12px;display:flex;gap:16px}
  .links a{color:var(--accent);text-decoration:none;font-size:16px;font-weight:600;padding:8px 16px;background:rgba(56,189,248,0.1);border-radius:8px;border:1px solid rgba(56,189,248,0.3);transition:all 0.2s}
  .links a:hover{text-decoration:none;background:rgba(56,189,248,0.2);border-color:var(--accent)}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
  .controls{padding:12px}
  label.small{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
  input[type=file]{width:100%}
  .row{display:flex;gap:8px;align-items:center;margin-top:10px}
  select,button,input{background:#07101b;border:1px solid rgba(255,255,255,0.04);color:inherit;padding:8px;border-radius:8px}
  button.primary{background:linear-gradient(180deg,var(--accent),#0ea5b5);color:#012;font-weight:700;border:none;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
  #preview{border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#07101b;display:block;image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges}
  .log{margin-top:10px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);min-height:60px;max-height:120px;overflow:auto;font-size:12px;color:#cfe4ff}
  .right{padding:12px;border-left:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column}
  .preview-container{flex:1;display:flex;align-items:flex-start;justify-content:center;overflow:auto;min-height:200px;max-height:400px}
  .meta{font-size:13px;color:var(--muted);margin-top:8px}
  a.download-link{display:inline-block;margin-left:8px;padding:8px 12px;border-radius:8px;background:var(--ok);color:#042; font-weight:700;text-decoration:none}
  footer{margin-top:12px;color:var(--muted);font-size:13px}
  .dropzone{border:2px dashed rgba(255,255,255,0.03);border-radius:8px;padding:18px;text-align:center;color:var(--muted);cursor:pointer}
  .discord-widget{display:flex;justify-content:center;margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.05)}
  .discord-widget a{display:inline-flex;align-items:center;gap:10px;padding:16px 32px;background:linear-gradient(135deg,#5865F2,#7289DA);color:#fff;text-decoration:none;font-size:16px;font-weight:600;border-radius:10px;box-shadow:0 4px 16px rgba(88,101,242,0.3);transition:all 0.3s}
  .discord-widget a:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(88,101,242,0.5)}
  .discord-stats{display:flex;gap:16px;font-size:13px;opacity:0.9}
  .discord-stats span{display:flex;align-items:center;gap:4px}
</style>
</head>
<body>
  <div class="card" role="application" aria-label="PNG Strip Generator">
    <h1>PNG Strip Generator</h1>
    <p class="lead">Upload a GIF (drag & drop supported). Tool extracts every frame and creates a vertical PNG strip.</p>
    <div class="links">
      <a href="https://github.com/KarmaCombo" target="_blank" rel="noopener">GitHub</a>
      <a href="https://discord.gg/tbTwsJcjRM" target="_blank" rel="noopener">Discord</a>
    </div>

    <div class="grid">
      <div class="controls">
        <label class="small">Upload GIF</label>
        <div id="drop" class="dropzone">Click or drop GIF here</div>
        <input id="fileInput" type="file" accept="image/gif" style="display:none" />

        <div class="row">
          <div style="flex:1">
            <label class="small">Resize (optional)</label>
            <select id="size">
              <option value="Original">Original</option>
              <option value="16">16</option>
              <option value="32">32</option>
              <option value="64">64</option>
            </select>
          </div>

          <div>
            <label class="small">Frame time</label>
            <select id="frametime">
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <button id="generate" class="primary">Generate & Package ZIP</button>
          <button id="downloadPng" class="ghost" disabled>Download PNG</button>
          <a id="downloadZip" class="download-link" style="display:none">Download ZIP</a>
        </div>

        <div class="meta" id="metaInfo">No GIF loaded</div>

        <div class="log" id="log" aria-live="polite"></div>
      </div>

      <div class="right">
        <div><strong>Preview (In-game animation)</strong></div>
        <div class="preview-container">
          <img id="preview" style="margin-top:10px;max-width:100%;height:auto" alt="Animation preview" />
        </div>
        <div class="meta" id="framesInfo"></div>
      </div>
    </div>

    <div class="discord-widget">
      <a href="https://discord.com/invite/tbTwsJcjRM" target="_blank" rel="noopener">
        <div>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
            </svg>
            <span>AIO - support server</span>
          </div>
          <div class="discord-stats">
            <span>üü¢ <span id="onlineCount">...</span> Online</span>
            <span>üë• <span id="memberCount">...</span> Members</span>
          </div>
        </div>
      </a>
    </div>
  </div>

  <!-- libs: omggif + jszip -->
  <script src="https://cdn.jsdelivr.net/npm/omggif@1.0.10/omggif.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
(() => {
  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('fileInput');
  const logEl = document.getElementById('log');
  const preview = document.getElementById('preview');
  const sizeSel = document.getElementById('size');
  const generateBtn = document.getElementById('generate');
  const downloadPngBtn = document.getElementById('downloadPng');
  const downloadZipA = document.getElementById('downloadZip');
  const metaInfo = document.getElementById('metaInfo');
  const framesInfo = document.getElementById('framesInfo');
  const frametimeSel = document.getElementById('frametime');

  let loadedArrayBuffer = null;
  let lastPngBlob = null;
  let lastZipBlob = null;
  let lastFramesCount = 0;
  let lastWidth = 0, lastHeight = 0;

  function log(msg){ const d = document.createElement('div'); d.textContent = msg; logEl.prepend(d); }

  // drag/drop
  drop.addEventListener('click', ()=> fileInput.click());
  drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.borderColor = '#38bdf8'; });
  drop.addEventListener('dragleave', ()=>{ drop.style.borderColor = ''; });
  drop.addEventListener('drop', e=>{ e.preventDefault(); drop.style.borderColor=''; handleFiles(e.dataTransfer.files); });

  fileInput.addEventListener('change', ()=> handleFiles(fileInput.files));

  function handleFiles(files){
    if(!files || !files.length) return;
    const f = files[0];
    
    // Validate file type
    if(!f.type || !f.type.includes('gif')) { 
      alert('‚ùå Please upload a GIF file.\n\nFile type: ' + (f.type || 'unknown')); 
      return; 
    }
    
    // Check file size (warn if > 50MB)
    const sizeMB = f.size / (1024 * 1024);
    if (sizeMB > 50) {
      if (!confirm(`This GIF is ${sizeMB.toFixed(1)}MB. Large files may be slow to process. Continue?`)) {
        return;
      }
    }
    
    metaInfo.textContent = 'Loading GIF: ' + f.name;
    log('Loading file: ' + f.name + ' (' + Math.round(f.size/1024) + ' KB)');
    
    const reader = new FileReader();
    reader.onload = () => {
      loadedArrayBuffer = reader.result;
      const sizeKB = Math.round(f.size/1024);
      metaInfo.textContent = `Loaded: ${f.name} (${sizeKB} KB)`;
      log('‚úÖ GIF loaded successfully');
      framesInfo.textContent = 'Ready to convert';
      
      // Show animated preview
      const blob = new Blob([reader.result], { type: 'image/gif' });
      const url = URL.createObjectURL(blob);
      preview.src = url;
      preview.style.maxWidth = '200px';
    };
    reader.onerror = (e)=> { 
      alert('‚ùå Failed to read file. Please try again.'); 
      console.error('FileReader error:', e); 
      log('‚ùå Failed to read file');
    };
    reader.readAsArrayBuffer(f);
  }

  // core: extract frames using omggif
  function decomposeGif(arrayBuffer){
    if(!window.GifReader){
      throw new Error('omggif not found. Make sure the script is loaded.');
    }

    const bytes = new Uint8Array(arrayBuffer);
    
    // Validate GIF header
    if (bytes.length < 6 || 
        String.fromCharCode(bytes[0], bytes[1], bytes[2]) !== 'GIF') {
      throw new Error('Invalid GIF file format');
    }
    
    let reader;
    try {
      reader = new GifReader(bytes);
    } catch(err) {
      throw new Error('Failed to parse GIF: ' + err.message);
    }

    const w = reader.width;
    const h = reader.height;
    const numFrames = reader.numFrames();
    
    if (numFrames === 0) {
      throw new Error('GIF contains no frames');
    }
    
    if (w === 0 || h === 0) {
      throw new Error('Invalid GIF dimensions');
    }

    log(`Processing ${numFrames} frame${numFrames > 1 ? 's' : ''}...`);
    const frameCanvases = [];

    // We'll render each frame completely independently for Minecraft
    // Minecraft expects each frame in the strip to be complete, not composited
    for(let i=0; i<numFrames; i++){
      try {
        // Create a fresh canvas for each frame
        const frameCanvas = document.createElement('canvas');
        frameCanvas.width = w;
        frameCanvas.height = h;
        const frameCtx = frameCanvas.getContext('2d');

        // Decode frame pixels
        const pixels = new Uint8ClampedArray(w * h * 4);
        reader.decodeAndBlitFrameRGBA(i, pixels);

        // Put the decoded pixels on the canvas
        const imageData = new ImageData(pixels, w, h);
        frameCtx.putImageData(imageData, 0, 0);
        
        frameCanvases.push(frameCanvas);
      } catch(err) {
        console.error(`Error processing frame ${i}:`, err);
        throw new Error(`Failed to decode frame ${i + 1} of ${numFrames}`);
      }
    }

    return { canvases: frameCanvases, width: w, height: h };
  }

  // stitch vertical strip (top-down), optionally resizing each frame to sizeChoice
  // Minecraft requires square textures
  async function makeStrip(canvases, w, h, sizeChoice){
    // Determine target size - must be square
    let targetSize;
    if (sizeChoice === 'Original') {
      targetSize = Math.max(w, h); // Make it square using the larger dimension
    } else {
      targetSize = parseInt(sizeChoice, 10);
    }
    
    const totalH = targetSize * canvases.length;
    const strip = document.createElement('canvas');
    strip.width = targetSize;
    strip.height = totalH;
    const sctx = strip.getContext('2d');
    
    // Clear canvas with transparency
    sctx.clearRect(0, 0, targetSize, totalH);

    for(let i=0;i<canvases.length;i++){
      try {
        // Calculate scale to fit frame in square while maintaining aspect ratio
        const scale = Math.min(targetSize / w, targetSize / h);
        const scaledW = w * scale;
        const scaledH = h * scale;
        
        // Center the image in the square
        const offsetX = (targetSize - scaledW) / 2;
        const offsetY = (targetSize - scaledH) / 2;
        
        sctx.drawImage(canvases[i], offsetX, i * targetSize + offsetY, scaledW, scaledH);
        
        // small yield for large gifs
        if(i % 50 === 0) await new Promise(r => setTimeout(r,0));
      } catch(err) {
        console.error(`Failed to draw frame ${i}:`, err);
        throw new Error(`Failed to process frame ${i + 1} of ${canvases.length}`);
      }
    }

    return strip;
  }

  // create mcmeta text
  function makeMcmeta(frametime){
    return JSON.stringify({ animation: { frametime: Number(frametime) } }, null, 2);
  }

  // generate zip and enable downloads
  async function generatePack(){
    try{
      if(!loadedArrayBuffer) { alert('No GIF loaded. Drag & drop a GIF into the left panel.'); return; }

      // Reset previous state
      downloadPngBtn.disabled = true;
      downloadZipA.style.display = 'none';
      
      // Revoke old blob URLs to free memory
      if(lastPngBlob) {
        URL.revokeObjectURL(lastPngBlob);
        lastPngBlob = null;
      }
      if(lastZipBlob) {
        URL.revokeObjectURL(lastZipBlob);
        lastZipBlob = null;
      }

      log('Parsing GIF frames (this may take a moment)...');
      const parsed = decomposeGif(loadedArrayBuffer);
      const canvases = parsed.canvases;
      const w = parsed.width; const h = parsed.height;
      lastFramesCount = canvases.length;
      lastWidth = w; lastHeight = h;

      log(`Frames extracted: ${canvases.length} ‚Äî size: ${w}√ó${h}`);

      const sizeChoice = sizeSel.value;
      log('Creating vertical strip...');
      const strip = await makeStrip(canvases, w, h, sizeChoice);

      // Preview remains as animated GIF from original upload
      log('Strip created successfully');

      // convert strip to blob
      const pngBlob = await new Promise(res=>strip.toBlob(res, 'image/png'));
      lastPngBlob = pngBlob;

      // prepare mcmeta for texture animation
      const textureMcmeta = makeMcmeta(frametimeSel.value);

      // prepare pack.mcmeta for resource pack
      const packMcmeta = JSON.stringify({
        pack: {
          pack_format: 34,
          description: "Animated Totem Texture Pack"
        }
      }, null, 2);

      // prepare zip with proper Minecraft resource pack structure
      log('Packaging Minecraft resource pack...');
      const zip = new JSZip();
      
      // Root level: pack.mcmeta and pack.png (icon)
      zip.file('pack.mcmeta', packMcmeta);
      
      // Create a simple pack icon from first frame
      const iconCanvas = document.createElement('canvas');
      iconCanvas.width = 128;
      iconCanvas.height = 128;
      const iconCtx = iconCanvas.getContext('2d');
      iconCtx.drawImage(canvases[0], 0, 0, 128, 128);
      const iconBlob = await new Promise(res=>iconCanvas.toBlob(res, 'image/png'));
      zip.file('pack.png', iconBlob);
      
      // Proper texture path: assets/minecraft/textures/item/
      const textureFolder = zip.folder('assets').folder('minecraft').folder('textures').folder('item');
      textureFolder.file('totem_of_undying.png', pngBlob);
      textureFolder.file('totem_of_undying.png.mcmeta', textureMcmeta);
      
      const zipBlob = await zip.generateAsync({type:'blob'});
      log('Done packaging resource pack.');

      lastZipBlob = zipBlob;
      // create download links
      const pngUrl = URL.createObjectURL(pngBlob);
      downloadPngBtn.onclick = ()=> { const a=document.createElement('a'); a.href=pngUrl; a.download='totem_of_undying.png'; a.click(); };
      downloadPngBtn.disabled = false;

      const zipUrl = URL.createObjectURL(zipBlob);
      downloadZipA.href = zipUrl;
      downloadZipA.download = 'TotemTexture.zip';
      downloadZipA.style.display = 'inline-block';

      metaInfo.textContent = `Frames: ${canvases.length} ‚Ä¢ Frame size: ${w}√ó${h} ‚Ä¢ Output: ${strip.width}√ó${strip.height}px`;
      framesInfo.textContent = `Strip: ${strip.width}√ó${strip.height} ‚Ä¢ Resize: ${sizeChoice} ‚Ä¢ Frame time: ${frametimeSel.value}`;
      log('‚úÖ Done ‚Äî Resource pack ready for download!');
    }catch(err){
      console.error('Generation error:', err);
      const errorMsg = err.message || 'Unknown error occurred';
      alert('‚ùå Error: ' + errorMsg + '\n\nPlease check the console for details.');
      log('‚ùå Error: ' + errorMsg);
      
      // Reset UI state on error
      downloadPngBtn.disabled = true;
      downloadZipA.style.display = 'none';
    }
  }

  generateBtn.addEventListener('click', generatePack);

  // Fetch Discord server stats
  async function fetchDiscordStats() {
    try {
      const response = await fetch('https://discord.com/api/v10/invites/tbTwsJcjRM?with_counts=true');
      const data = await response.json();
      if (data.approximate_member_count) {
        document.getElementById('memberCount').textContent = data.approximate_member_count.toLocaleString();
      }
      if (data.approximate_presence_count) {
        document.getElementById('onlineCount').textContent = data.approximate_presence_count.toLocaleString();
      }
    } catch (err) {
      console.error('Failed to fetch Discord stats:', err);
      document.getElementById('memberCount').textContent = '?';
      document.getElementById('onlineCount').textContent = '?';
    }
  }
  
  fetchDiscordStats();

})();
</script>
</body>
</html>
